{% extends "core/base.html" %}
{% load static i18n %}
{% get_current_language as CURRENT_LANG %}

{% block title %}{{ page_title }}{% endblock %}
{% block meta_description %}{{ page_description }}{% endblock %}
{% block og_title %}{{ page_title }}{% endblock %}
{% block og_description %}{{ page_description }}{% endblock %}
{% block og_image %}{% endblock %}

{% block extra_meta %}
  <link rel="canonical" href="https://lazysoft.pl{{ request.path }}" />
  
  <link rel="alternate" href="https://lazysoft.pl/en/news/" hreflang="en">
  <link rel="alternate" href="https://lazysoft.pl/uk/news/" hreflang="uk">
  <link rel="alternate" href="https://lazysoft.pl/pl/news/" hreflang="pl">
  
  <link rel="stylesheet" href="{% static 'css/sections/news_list.css' %}">
  <link rel="stylesheet" href="{% static 'css/sidebar_desktop.css' %}?v=1.3">
  <link rel="stylesheet" href="{% static 'css/sidebar_mobile.css' %}?v=1.3">
  
  <script type="application/ld+json">
  {{ structured_data|safe }}
  </script>
  
  <!-- Google News Reader Revenue Manager - —Ç—ñ–ª—å–∫–∏ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –Ω–æ–≤–∏–Ω -->
  <script data-cfasync="false" async src="https://news.google.com/swg/js/v1/swg-basic.js"></script>
  <script>
    // –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–ª—è –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è
    console.log('RRM: Initializing SWG Basic...');
    console.log('RRM: Current domain:', window.location.hostname);
    console.log('RRM: Current language:', '{{ CURRENT_LANG|default:"en" }}');

    (self.SWG_BASIC = self.SWG_BASIC || []).push(basic => {
      console.log('RRM: SWG Basic loaded, initializing...');

      // –°–ø—Ä–æ–±—É—î–º–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é
      try {
        basic.init({
          type: "Product",
          isPartOfType: ["Product"],
          isPartOfProductId: "CAown-DCDA:openaccess",
          clientOptions: {
            theme: "dark",
            lang: "{{ CURRENT_LANG|default:'en' }}"
          }
        });
        console.log('RRM: SWG Basic initialized successfully');
      } catch (error) {
        console.error('RRM: Error initializing SWG Basic:', error);

        // –°–ø—Ä–æ–±—É—î–º–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é
        try {
          basic.init({
            type: "Product",
            isPartOfType: ["Product"],
            isPartOfProductId: "CAown-DCDA:default",
            clientOptions: {
              theme: "light",
              lang: "{{ CURRENT_LANG|default:'en' }}"
            }
          });
          console.log('RRM: SWG Basic initialized with alternative config');
        } catch (altError) {
          console.error('RRM: Alternative config also failed:', altError);
        }
      }
    });

    // –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫
    window.addEventListener('error', function(e) {
      if (e.message.includes('swg') || e.message.includes('SWG')) {
        console.error('RRM Error:', e.message, e.filename, e.lineno);
      }
    });
  </script>
{% endblock %}

{% block content %}
<main class="news-page">

  <section class="news-header py-16">
    <div class="container max-w-4xl mx-auto text-center">
      {% if current_category %}
        <div class="category-hero">
          <div>
            <h1>{{ current_category.get_name|safe }}</h1>
          </div>
        </div>
        <p>{{ current_category.get_description|safe }}</p>
      {% else %}
        <h1>{% trans "TECH INSIGHTS by LAZYSOFT" %}</h1>
        
        <p>{% trans "Not just news ‚Äî business insights for European entrepreneurs" %}</p>
      {% endif %}
    </div>
  </section>

  <!-- Google News Reader Revenue Manager - —Ñ–æ—Ä–º–∞ –ø—ñ–¥–ø–∏—Å–∫–∏ -->
  <section id="newsletter-cta" class="glass my-6 p-4 rounded-2xl" style="margin: 2rem auto; max-width: 600px;">
    <div class="container">
      <div class="text-center">
        <h3>LazySoft Tech News</h3>
        <p>Get field notes from the AI & automation frontier. Sent daily. Opt out anytime.</p>
        <div id="rrm-signup"></div>

        <!-- –î—ñ–∞–≥–Ω–æ—Å—Ç–∏—á–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –¥–ª—è –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è -->
        <div id="rrm-debug" style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px; font-family: monospace; font-size: 12px; text-align: left;">
          <strong>RRM Debug:</strong><br>
          Domain: <span id="debug-domain"></span><br>
          Language: <span id="debug-lang"></span><br>
          Product ID: <span id="debug-product-id"></span><br>
          Configuration ID: <span id="debug-config-id"></span><br>
          Status: <span id="debug-status">Waiting for SWG...</span>
        </div>

        <!-- –¢–µ—Å—Ç–æ–≤–∞ –∫–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ RRM -->
        <button id="test-rrm-btn" onclick="testRRM()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
          –¢–µ—Å—Ç—É–≤–∞—Ç–∏ RRM —Ñ–æ—Ä–º—É
        </button>
      </div>
    </div>
  </section>

  <script>
    // –ó–∞–ø–æ–≤–Ω–∏–º–æ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏—á–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('debug-domain').textContent = window.location.hostname;
      document.getElementById('debug-lang').textContent = '{{ CURRENT_LANG|default:"en" }}';
      document.getElementById('debug-product-id').textContent = 'CAown-DCDA:openaccess';
      document.getElementById('debug-config-id').textContent = '0a3bd8ef-990d-4253-bcbe-c9c3de0ca2bc';

      // –°–ª—É—Ö–∞—î–º–æ –∑–º—ñ–Ω–∏ —Å—Ç–∞—Ç—É—Å—É SWG
      if (typeof self.SWG_BASIC !== 'undefined') {
        document.getElementById('debug-status').textContent = 'SWG Basic loaded';
      }
    });

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è RRM
    function testRRM() {
      console.log('Testing RRM form...');

      if (typeof self.SWG_BASIC === 'undefined') {
        console.error('SWG Basic not loaded');
        alert('SWG Basic –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ. –°–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É.');
        return;
      }

        // –°–ø—Ä–æ–±—É—î–º–æ –ø–æ–∫–∞–∑–∞—Ç–∏ —Ñ–æ—Ä–º—É –ø—ñ–¥–ø–∏—Å–∫–∏
        try {
          console.log('SWG_BASIC array:', self.SWG_BASIC);
          console.log('SWG_BASIC length:', self.SWG_BASIC ? self.SWG_BASIC.length : 'undefined');

          // –°–ø—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ SWG –æ–±'—î–∫—Ç
          if (self.SWG_BASIC && self.SWG_BASIC.length > 0) {
            const swg = self.SWG_BASIC[self.SWG_BASIC.length - 1];
            console.log('Found SWG object:', swg);

            // –°–ø—Ä–æ–±—É—î–º–æ –ø–æ–∫–∞–∑–∞—Ç–∏ —Ñ–æ—Ä–º—É
            swg.showOffers({
              isClosable: true
            }).then(result => {
              console.log('RRM form opened successfully:', result);
            }).catch(error => {
              console.error('Error opening RRM form:', error);
              alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ —Ñ–æ—Ä–º–∏: ' + error.message);
            });
          } else {
            console.error('No SWG object found');
            alert('SWG –æ–±\'—î–∫—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –¥–æ–º–µ–Ω lazysoft.pl –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ –≤ Google Publisher Center.');
          }
      } catch (error) {
        console.error('Error in testRRM:', error);
        alert('–ü–æ–º–∏–ª–∫–∞ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è: ' + error.message);
      }
    }
  </script>

  <section class="news-main-section">
    <div class="container">
      <div class="news-layout">
        
        <div class="news-content">
          
          {% if articles %}
            <div class="news-grid">
              {% for article in articles %}
              <article class="news-card clickable" data-href="{{ article.get_absolute_url }}">
                
                {% if article.ai_image_url %}
                  <img src="{{ article.ai_image_url }}" 
                       alt="{{ article.get_title }}" 
                       loading="lazy"
                       class="news-image">
                {% endif %}
                
                <div class="news-meta">
                  <span class="category-chip">
                    {{ article.category.icon }}
                    {{ article.category.get_name }}
                  </span>
                  
                  {% if article.is_top_article and article.article_rank and article.get_word_count > 500 %}
                    <span class="top-chip">üèÜ TOP {{ article.article_rank }}</span>
                  {% elif article.priority >= 3 %}
                    <span class="hot-chip">üî• HOT</span>
                  {% endif %}
                </div>

                <h3>
                  {{ article.get_title|safe }}
                </h3>

                <p class="news-summary">
                  {{ article.get_summary|safe|truncatewords:15 }}
                </p>

                <div class="news-footer">
                  <time datetime="{{ article.published_at|date:'c' }}" class="news-date">
                    <i data-lucide="calendar"></i>
                    {{ article.published_at|date:'j.m.Y' }}
                  </time>
                  <span class="news-views">
                    <i data-lucide="eye"></i>
                    {{ article.get_total_views }}
                  </span>
                  <span class="news-time">
                    <i data-lucide="clock"></i>
                    {{ article.get_reading_time }}—Ö–≤
                  </span>
                  {% if article.original_source_url and article.original_source_name %}
                    <a href="{{ article.original_source_url }}" target="_blank" rel="nofollow noopener" class="source-link">
                      <i data-lucide="external-link"></i>
                      {{ article.original_source_name }}
                    </a>
                  {% endif %}
                  <span class="read-more">
                    <i data-lucide="arrow-right"></i>
                  </span>
                </div>
              </article>
              {% endfor %}
            </div>

            {% if is_paginated %}
            <nav class="pagination-nav">
              {% if page_obj.has_previous %}
              <a href="?page={{ page_obj.previous_page_number }}" class="pagination-btn">
                <i data-lucide="chevron-left"></i>
                <span>{% trans "Previous" %}</span>
              </a>
              {% endif %}
              
              <span class="pagination-current">
                {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
              </span>
              
              {% if page_obj.has_next %}
              <a href="?page={{ page_obj.next_page_number }}" class="pagination-btn">
                <span>{% trans "Next" %}</span>
                <i data-lucide="chevron-right"></i>
              </a>
              {% endif %}
            </nav>
            {% endif %}
            
          {% else %}
            <div class="empty-state">
              <div class="empty-icon">
                <i data-lucide="newspaper"></i>
              </div>
              <h2>{% trans "No news yet in this category" %}</h2>
              <p>{% trans "Fresh tech insights are coming soon. Check back later!" %}</p>
              <a href="{% url 'news:news_list' %}" class="back-link">
                <i data-lucide="chevron-left"></i>
                <span>{% trans "View all news" %}</span>
              </a>
            </div>
          {% endif %}
          
        </div>

        <aside class="news-sidebar">
          {% include 'includes/news_sidebar.html' %}
        </aside>

      </div>
    </div>
  </section>

  {% include 'includes/related_work_section.html' %}
  

  {% include 'includes/social_share.html' %}

</main>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/services_sidebar.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  if (typeof lucide !== 'undefined') {
    lucide.createIcons();
  }
});
</script>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "{{ page_title|escapejs }}",
  "description": "{{ page_description|escapejs }}",
  "url": "https://lazysoft.pl{{ request.path }}",
  "inLanguage": "{{ CURRENT_LANG }}",
  "publisher": {
    "@type": "Organization",
    "name": "LAZYSOFT",
    "logo": {
      "@type": "ImageObject",
      "url": "https://lazysoft.pl/static/images/logo.png"
    }
  },
  "mainEntity": {
    "@type": "ItemList",
    "itemListElement": [
      {% for article in articles %}
      {
        "@type": "ListItem",
        "position": {{ forloop.counter }},
        "url": "https://lazysoft.pl{{ article.get_absolute_url }}",
        "name": "{{ article.get_title|escapejs }}"
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ]
  }
}
</script>
{% endblock %}