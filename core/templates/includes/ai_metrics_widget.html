{% load static i18n %}
<!-- ü§ñ AI METRICS WIDGET -->
<section class="ai-metrics-widget">
    
    <!-- üìä –ó–ê–ì–û–õ–û–í–û–ö -->
    <div class="widget-header">
        <h2 class="widget-title" data-lang="uk">ü§ñ AI –ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –≤ –î—ñ—ó</h2>
        <p class="widget-subtitle">{% trans "–†–µ–∞–ª—å–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—ó –¥–ª—è –≤–∞—à–æ–≥–æ –±—ñ–∑–Ω–µ—Å—É" %}</p>
    </div>

    <!-- üìà –°–Ü–¢–ö–ê –ú–ï–¢–†–ò–ö -->
    <div class="metrics-grid">
        
        <!-- ROI Performance -->
        <div class="metric-card roi">
            <h3 class="metric-label">{% trans "ROI –ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å" %}</h3>
            <p class="metric-value live">
                {{ dashboard_data.roi_analysis.total_roi|default:"127" }}<span class="metric-unit">%</span>
                <span class="trend-indicator trend-up">‚Üó</span>
            </p>
            <p class="metric-description">{% trans "–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å AI —ñ–Ω–≤–µ—Å—Ç–∏—Ü—ñ–π" %}</p>
        </div>

        <!-- Time Saved -->
        <div class="metric-card time">
            <h3 class="metric-label">{% trans "–ó–µ–∫–æ–Ω–æ–º–ª–µ–Ω–æ –ß–∞—Å—É" %}</h3>
            <p class="metric-value live">
                {{ dashboard_data.key_kpis.ai_efficiency.hours_saved|default:"240" }}<span class="metric-unit">{% trans "–≥–æ–¥" %}</span>
                <span class="trend-indicator trend-up">‚Üó</span>
            </p>
            <p class="metric-description">{% trans "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—è —Ä–æ–±–æ—á–∏—Ö –ø—Ä–æ—Ü–µ—Å—ñ–≤" %}</p>
        </div>

        <!-- AI Content -->
        <div class="metric-card content">
            <h3 class="metric-label">{% trans "AI –ö–æ–Ω—Ç–µ–Ω—Ç" %}</h3>
            <p class="metric-value live">
                {{ dashboard_data.content_overview.articles|default:"85" }}<span class="metric-unit">{% trans "—à—Ç" %}</span>
                <span class="trend-indicator trend-up">‚Üó</span>
            </p>
            <p class="metric-description">{% trans "–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ AI —Å—Ç–∞—Ç–µ–π —Ü—å–æ–≥–æ –º—ñ—Å—è—Ü—è" %}</p>
        </div>

        <!-- Process Efficiency -->
        <div class="metric-card efficiency">
            <h3 class="metric-label">{% trans "–ó—Ä–æ—Å—Ç–∞–Ω–Ω—è –ï—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ" %}</h3>
            <p class="metric-value live">
                +{{ dashboard_data.key_kpis.ai_efficiency.efficiency_score|default:"340" }}<span class="metric-unit">%</span>
                <span class="trend-indicator trend-up">‚Üó</span>
            </p>
            <p class="metric-description">{% trans "–ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –ø—Ä–æ—Ü–µ—Å—ñ–≤" %}</p>
        </div>

    </div>

    <!-- üéØ CALL TO ACTION -->
    <div class="metrics-cta">
        <a href="{% url 'contacts:contact_page' %}" class="cta-button">
            <span>{% trans "–ó–∞–º–æ–≤–∏—Ç–∏ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é" %}</span>
        </a>
    </div>

    <!-- ‚è∞ –û–°–¢–ê–ù–ù–Ø –û–ù–û–í–õ–ï–ù–ù–Ø -->
    <div class="last-updated">
        {% trans "–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:" %} <span id="lastUpdated">{% trans "—Å—å–æ–≥–æ–¥–Ω—ñ, 14:30" %}</span>
    </div>
</section>

<!-- üì° AJAX SCRIPT -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // üîÑ –õ–Ü–ß–ò–õ–¨–ù–ò–ö –ê–ù–Ü–ú–ê–¶–Ü–Ø
    function animateCounters() {
        document.querySelectorAll('.metric-value').forEach(element => {
            const text = element.textContent;
            const target = parseInt(text.replace(/[^\d]/g, ''));
            if (isNaN(target)) return;
            
            const duration = 2000;
            const step = target / duration * 16;
            let current = 0;
            
            const counter = setInterval(() => {
                current += step;
                if (current >= target) {
                    current = target;
                    clearInterval(counter);
                }
                
                const unit = element.querySelector('.metric-unit');
                const trend = element.querySelector('.trend-indicator');
                const unitText = unit ? unit.outerHTML : '';
                const trendText = trend ? trend.outerHTML : '';
                
                element.innerHTML = Math.floor(current) + unitText + trendText;
            }, 16);
        });
    }

    // üïí –û–ù–û–í–õ–ï–ù–ù–Ø –ß–ê–°–£
    function updateTimestamp() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('{{ LANGUAGE_CODE }}', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        document.getElementById('lastUpdated').textContent = `{% trans "—Å—å–æ–≥–æ–¥–Ω—ñ" %}, ${timeStr}`;
    }

    // üì° –ê–í–¢–û–û–ù–û–í–õ–ï–ù–ù–Ø –î–ê–ù–ò–•
    async function updateMetrics() {
        try {
            const response = await fetch('/news/api/roi-dashboard/');
            const data = await response.json();
            
            if (data.success) {
                // –û–Ω–æ–≤–∏—Ç–∏ –∑–Ω–∞—á–µ–Ω–Ω—è –º–µ—Ç—Ä–∏–∫
                updateMetricValues(data);
                updateTimestamp();
            }
        } catch (error) {
            console.log('Metrics update failed:', error);
        }
    }

    function updateMetricValues(data) {
        // –û–Ω–æ–≤–ª—é—î–º–æ ROI
        if (data.today && data.today.roi_percentage) {
            const roiElement = document.querySelector('.roi .metric-value');
            if (roiElement) {
                roiElement.innerHTML = `${Math.round(data.today.roi_percentage)}<span class="metric-unit">%</span><span class="trend-indicator trend-up">‚Üó</span>`;
            }
        }
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –≥–æ–¥–∏–Ω–∏
        if (data.today && data.today.hours_saved) {
            const hoursElement = document.querySelector('.time .metric-value');
            if (hoursElement) {
                hoursElement.innerHTML = `${Math.round(data.today.hours_saved)}<span class="metric-unit">{% trans "–≥–æ–¥" %}</span><span class="trend-indicator trend-up">‚Üó</span>`;
            }
        }
        
        // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—Ç—ñ
        if (data.today && data.today.articles_processed) {
            const articlesElement = document.querySelector('.content .metric-value');
            if (articlesElement) {
                articlesElement.innerHTML = `${data.today.articles_processed}<span class="metric-unit">{% trans "—à—Ç" %}</span><span class="trend-indicator trend-up">‚Üó</span>`;
            }
        }
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å
        if (data.today && data.today.time_efficiency) {
            const efficiencyElement = document.querySelector('.efficiency .metric-value');
            if (efficiencyElement) {
                efficiencyElement.innerHTML = `+${Math.round(data.today.time_efficiency)}<span class="metric-unit">%</span><span class="trend-indicator trend-up">‚Üó</span>`;
            }
        }
    }

    // üöÄ –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
    setTimeout(animateCounters, 500);
    updateTimestamp();
    
    // –ê–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 5 —Ö–≤–∏–ª–∏–Ω
    setInterval(updateMetrics, 300000);
});
</script>
