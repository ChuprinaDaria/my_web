{% load static i18n %}
<!-- ü§ñ AI METRICS WIDGET -->
<section class="ai-metrics-widget">
    
    <!-- üìä –ó–ê–ì–û–õ–û–í–û–ö -->
    <div class="widget-header">
        <h2>{% trans "ü§ñ AI –ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –≤ –î—ñ—ó" %}</h2>
        <p>{% trans "–†–µ–∞–ª—å–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—ó –¥–ª—è –≤–∞—à–æ–≥–æ –±—ñ–∑–Ω–µ—Å—É" %}</p>
    </div>

    <!-- üìà –°–Ü–¢–ö–ê –ú–ï–¢–†–ò–ö -->
    <div class="metrics-grid">
        
        <!-- –ó–∞–æ—â–∞–¥–∂–µ–Ω–æ –∫–æ—à—Ç—ñ–≤ -->
        <div class="metric-card roi">
            <h3>{% trans "–ó–∞–æ—â–∞–¥–∂–µ–Ω–æ –∫–æ—à—Ç—ñ–≤" %}</h3>
            <p class="metric-value live" id="roiValue">
                $0<span class="metric-unit"></span>
            </p>
            <p class="metric-description">{% trans "–ï–∫–æ–Ω–æ–º—ñ—è –≤—ñ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—ó –∑–∞ –ø–µ—Ä—ñ–æ–¥" %}</p>
        </div>

        <!-- AI Model -->
        <div class="metric-card ai-model">
            <h3>{% trans "–ú–æ–¥–µ–ª—å AI" %}</h3>
            <div class="metric-value live ai-model-container" id="aiModelValue">
                <div class="ai-model-logo">
                    <img src="https://www.gstatic.com/lamda/images/gemini_sparkle_v002_d4735304ff6292a690345.svg" alt="Gemini" style="width: 32px; height: 32px; display: block; margin: 0 auto 8px auto;" onerror="this.style.display='none'; this.nextElementSibling.textContent='üåü';">
                </div>
                <div class="ai-model-name">
                    <span id="aiModelName" style="color: #e91e63; font-weight: 700; text-shadow: none;">gemini</span>
                </div>
            </div>
            <p class="metric-description">{% trans "–û—Å–Ω–æ–≤–Ω–∞ –º–æ–¥–µ–ª—å –¥–ª—è –æ–±—Ä–æ–±–∫–∏" %}</p>
        </div>

        <!-- Time Saved -->
        <div class="metric-card time">
            <h3>{% trans "–ó–µ–∫–æ–Ω–æ–º–ª–µ–Ω–æ –ß–∞—Å—É" %}</h3>
            <p class="metric-value live" id="timeValue">
                0<span class="metric-unit">{% trans "–≥–æ–¥" %}</span>
            </p>
            <p class="metric-description">{% trans "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—è —Ä–æ–±–æ—á–∏—Ö –ø—Ä–æ—Ü–µ—Å—ñ–≤" %}</p>
        </div>

        <!-- AI Content -->
        <div class="metric-card content">
            <h3>{% trans "AI –ö–æ–Ω—Ç–µ–Ω—Ç" %}</h3>
            <p class="metric-value live" id="contentValue">
                0<span class="metric-unit">{% trans "—à—Ç" %}</span>
            </p>
            <p class="metric-description">{% trans "–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ AI —Å—Ç–∞—Ç–µ–π —Ü—å–æ–≥–æ –º—ñ—Å—è—Ü—è" %}</p>
        </div>

        <!-- Process Efficiency -->
        <div class="metric-card efficiency">
            <h3>{% trans "–ó—Ä–æ—Å—Ç–∞–Ω–Ω—è –ï—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ" %}</h3>
            <p class="metric-value live">
                +{{ dashboard_data.key_kpis.ai_efficiency.efficiency_score|default:"340" }}<span class="metric-unit">%</span>
            </p>
            <p class="metric-description">{% trans "–ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –ø—Ä–æ—Ü–µ—Å—ñ–≤" %}</p>
        </div>

        <!-- AI Spend -->
        <div class="metric-card ai-spend">
            <h3>{% trans "–í–∏—Ç—Ä–∞—Ç–∏ –Ω–∞ AI" %}</h3>
            <p class="metric-value live" id="aiCostValue">
                0.03<span class="metric-unit">$</span>
            </p>
            <p class="metric-description">{% trans "–í–∏—Ç—Ä–∞—á–µ–Ω–æ –Ω–∞ AI –º–æ–¥–µ–ª—ñ –∑–∞ –ø–µ—Ä—ñ–æ–¥" %}</p>
        </div>

        <!-- AI Time -->
        <div class="metric-card ai-time">
            <h3>{% trans "–ß–∞—Å AI –æ–±—Ä–æ–±–∫–∏" %}</h3>
            <p class="metric-value live" id="aiTimeValue">
                0.1<span class="metric-unit">{% trans "–≥–æ–¥" %}</span>
            </p>
            <p class="metric-description">{% trans "–ó–∞–≥–∞–ª—å–Ω–∏–π —á–∞—Å AI –æ–±—Ä–æ–±–∫–∏" %}</p>
        </div>


    </div>

    <!-- üéØ CALL TO ACTION -->
    <div class="metrics-cta">
        <a href="{% url 'contacts:contact_page' %}" class="cta-button">
            <span>{% trans "–ó–∞–º–æ–≤–∏—Ç–∏ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é" %}</span>
        </a>
    </div>

    <!-- ‚è∞ –û–°–¢–ê–ù–ù–Ø –û–ù–û–í–õ–ï–ù–ù–Ø -->
    <div class="last-updated">
        {% trans "–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:" %} <span id="lastUpdated">{% trans "—Å—å–æ–≥–æ–¥–Ω—ñ, 14:30" %}</span>
    </div>
</section>

<!-- üì° AJAX SCRIPT -->
<script>
// üåç WIDGET CONFIGURATION
const WIDGET_CONFIG = {
    language: '{{ LANGUAGE_CODE }}',
    translations: {
        today: '{% trans "—Å—å–æ–≥–æ–¥–Ω—ñ" %}',
        hours: '{% trans "–≥–æ–¥" %}',
        articles: '{% trans "—à—Ç" %}',
        percent: '{% trans "%" %}'
    }
};

document.addEventListener('DOMContentLoaded', function() {

    // üïí –û–ù–û–í–õ–ï–ù–ù–Ø –ß–ê–°–£
    function updateTimestamp() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString(WIDGET_CONFIG.language, { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        document.getElementById('lastUpdated').textContent = 
            `${WIDGET_CONFIG.translations.today}, ${timeStr}`;
    }

    // üì° –ê–í–¢–û–û–ù–û–í–õ–ï–ù–ù–Ø –î–ê–ù–ò–•
    async function updateMetrics() {
        try {
            const response = await fetch('/dashboard/public-api/?period=month');
            const data = await response.json();
            
            if (data) {
                updateMetricValues(data);
                updateTimestamp();
            }
        } catch (error) {
            // Silent fail
        }
    }

    function updateMetricValues(data) {
        if (!data || !data.data) {
            return;
        }
        
        if (data.data.roi_analysis) {
            const roiElement = document.getElementById('roiValue');
            if (roiElement && typeof data.data.roi_analysis.estimated_savings !== 'undefined') {
                const savings = data.data.roi_analysis.estimated_savings;
                roiElement.innerHTML = `$${savings.toFixed(0)}<span class="metric-unit"></span>`;
                roiElement.setAttribute('data-real-value', 'true');
            }
        }
        
        if (data.data.roi_analysis && data.data.roi_analysis.hours_saved) {
            const hoursElement = document.getElementById('timeValue');
            if (hoursElement) {
                hoursElement.innerHTML = `${data.data.roi_analysis.hours_saved}<span class="metric-unit">${WIDGET_CONFIG.translations.hours}</span>`;
                hoursElement.setAttribute('data-real-value', 'true');
            }
        }
        
        if (data.data.content_overview && data.data.content_overview.articles) {
            const articlesElement = document.getElementById('contentValue');
            if (articlesElement) {
                articlesElement.innerHTML = `${data.data.content_overview.articles}<span class="metric-unit">${WIDGET_CONFIG.translations.articles}</span>`;
                articlesElement.setAttribute('data-real-value', 'true');
            }
        }
        
        const efficiencyElement = document.querySelector('.efficiency .metric-value');
        if (efficiencyElement) {
            let efficiencyValue = 99;
            
            if (data.data.key_kpis && data.data.key_kpis.ai_efficiency && data.data.key_kpis.ai_efficiency.efficiency_score) {
                efficiencyValue = data.data.key_kpis.ai_efficiency.efficiency_score;
            } else if (data.data.roi_analysis && data.data.roi_analysis.efficiency_score) {
                efficiencyValue = data.data.roi_analysis.efficiency_score;
            }
            
            efficiencyElement.innerHTML = `+${Math.round(efficiencyValue)}<span class="metric-unit">%</span>`;
            efficiencyElement.setAttribute('data-real-value', 'true');
        }
        
        if (typeof data.data.ai_spend_usd !== 'undefined') {
            const aiCostElement = document.getElementById('aiCostValue');
            if (aiCostElement) {
                const spend = Number(data.data.ai_spend_usd || 0);
                aiCostElement.innerHTML = `${spend.toFixed(2)}<span class="metric-unit">$</span>`;
                aiCostElement.setAttribute('data-real-value', 'true');
            }
        }
        
        if (data.data.ai_spend_by_model) {
            const aiTimeElement = document.getElementById('aiTimeValue');
            if (aiTimeElement) {
                const modelData = Object.values(data.data.ai_spend_by_model)[0];
                if (modelData && modelData.avg_time) {
                    const totalTimeHours = (modelData.avg_time * modelData.calls) / 3600;
                    aiTimeElement.innerHTML = `${totalTimeHours.toFixed(1)}<span class="metric-unit">${WIDGET_CONFIG.translations.hours}</span>`;
                    aiTimeElement.setAttribute('data-real-value', 'true');
                }
            }
        }
        
        if (data.data.ai_top_model) {
            const aiModelElement = document.getElementById('aiModelName');
            const aiModelLogo = document.querySelector('.ai-model-logo img');
            if (aiModelElement && aiModelLogo) {
                const model = data.data.ai_top_model.toLowerCase();
                if (model.includes('gemini')) {
                    aiModelLogo.src = 'https://www.gstatic.com/lamda/images/gemini_sparkle_v002_d4735304ff6292a690345.svg';
                    aiModelLogo.style.width = '32px';
                    aiModelLogo.style.height = '32px';
                    aiModelLogo.style.display = 'block';
                    aiModelLogo.style.margin = '0 auto 8px auto';
                } else if (model.includes('gpt')) {
                    aiModelLogo.style.display = 'none';
                    aiModelLogo.nextElementSibling.textContent = 'üß†';
                } else if (model.includes('claude')) {
                    aiModelLogo.style.display = 'none';
                    aiModelLogo.nextElementSibling.textContent = 'üé≠';
                } else {
                    aiModelLogo.style.display = 'none';
                    aiModelLogo.nextElementSibling.textContent = 'ü§ñ';
                }
                aiModelElement.textContent = data.data.ai_top_model;
                aiModelElement.style.color = '#e91e63';
                aiModelElement.style.fontWeight = '700';
                aiModelElement.style.textShadow = 'none';
            }
        }
        
        if (data.last_updated) {
            const timeElement = document.getElementById('lastUpdated');
            if (timeElement) {
                timeElement.textContent = `—Å—å–æ–≥–æ–¥–Ω—ñ, ${data.last_updated}`;
            }
        }
    }

    updateTimestamp();
    updateMetrics();
    setInterval(updateMetrics, 300000);
});
</script>
