# Generated by Django 4.2.7 on 2025-08-13 10:20

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion
from django.utils.text import slugify


def backfill_unique_slugs(apps, schema_editor):
    Article = apps.get_model('news', 'ProcessedArticle')
    for obj in Article.objects.all().only(
        'id', 'uuid', 'slug', 'meta_title_uk', 'title_uk', 'title_en', 'title_pl'
    ):
        if obj.slug:
            continue
        base = (obj.meta_title_uk or obj.title_uk or obj.title_en or obj.title_pl or '')[:180]
        if not base:
            base = f"article-{obj.uuid}"
        slug = slugify(f"{base}-{str(obj.uuid)[:8]}")
        # –ø—Ä–æ –≤—Å—è–∫ ‚Äî —É–Ω—ñ–∫–∞–ª—ñ–∑–∞—Ü—ñ—è –Ω–∞ –≤–∏–ø–∞–¥–æ–∫ –∫–æ–ª—ñ–∑—ñ–π
        orig = slug
        i = 1
        while Article.objects.filter(slug=slug).exists():
            slug = f"{orig}-{i}"
            i += 1
        obj.slug = slug
        obj.save(update_fields=['slug'])


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0001_initial'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ('news', '0005_alter_processedarticle_options_and_more'),
    ]

    operations = [
        migrations.CreateModel(
            name='Comment',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('provider', models.CharField(choices=[('email', 'Email/Password'), ('google', 'Google'), ('facebook', 'Facebook'), ('linkedin', 'LinkedIn'), ('instagram', 'Instagram')], default='email', max_length=20)),
                ('display_name', models.CharField(blank=True, max_length=80)),
                ('body', models.TextField()),
                ('is_deleted', models.BooleanField(default=False)),
                ('is_blocked', models.BooleanField(default=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'ordering': ['created_at'],
            },
        ),
        migrations.DeleteModel(
            name='DashboardProxy',
        ),
        migrations.CreateModel(
            name='NewsSystemAnalytics',
            fields=[],
            options={
                'verbose_name': 'üöÄ News System Analytics',
                'verbose_name_plural': 'üöÄ News System Analytics',
                'proxy': True,
                'indexes': [],
                'constraints': [],
            },
            bases=('news.processedarticle',),
        ),
        migrations.AlterModelOptions(
            name='processedarticle',
            options={
                'ordering': ['-is_top_article', '-article_rank', '-priority', '-created_at'],
                'verbose_name': '–û–±—Ä–æ–±–ª–µ–Ω–∞ —Å—Ç–∞—Ç—Ç—è',
                'verbose_name_plural': '–û–±—Ä–æ–±–ª–µ–Ω—ñ —Å—Ç–∞—Ç—Ç—ñ'
            },
        ),
        migrations.AddField(
            model_name='newswidget',
            name='show_cross_promotion',
            field=models.BooleanField(default=False, verbose_name='–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –∫—Ä–æ—Å-–ø—Ä–æ–º–æ—Ü—ñ—é'),
        ),
        migrations.AddField(
            model_name='newswidget',
            name='show_tags',
            field=models.BooleanField(default=False, verbose_name='–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ —Ç–µ–≥–∏'),
        ),

        # --- –ö–†–û–ö 1: –¥–æ–¥–∞—î–º–æ slug –±–µ–∑ unique, –¥–æ–∑–≤–æ–ª—è—î–º–æ NULL ---
        migrations.AddField(
            model_name='processedarticle',
            name='slug',
            field=models.SlugField(
                verbose_name='Slug',
                help_text='–î–ª—è /news/top/<slug>/',
                max_length=220,
                blank=True,
                null=True,
                unique=False,
            ),
        ),

        migrations.AddField(
            model_name='processedarticle',
            name='tags',
            field=models.ManyToManyField(
                blank=True,
                help_text='–í–Ω—É—Ç—Ä—ñ—à–Ω—ñ —Ç–µ–≥–∏ –¥–ª—è –∫—Ä–æ—Å-–≤–∏–¥–∞—á—ñ –∑ –ø—Ä–æ—î–∫—Ç–∞–º–∏ —Ç–∞ —Å–µ—Ä–≤—ñ—Å–∞–º–∏',
                related_name='articles',
                to='core.tag'
            ),
        ),
        migrations.AddField(
            model_name='roianalytics',
            name='cross_promotion_success_rate',
            field=models.FloatField(default=0, verbose_name='–£—Å–ø—ñ—à–Ω—ñ—Å—Ç—å –∫—Ä–æ—Å-–ø—Ä–æ–º–æ—Ü—ñ—ó (%)'),
        ),
        migrations.AddField(
            model_name='roianalytics',
            name='tag_engagement_stats',
            field=models.JSONField(default=dict, verbose_name='–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–ª—É—á–µ–Ω–Ω—è –ø–æ —Ç–µ–≥–∞—Ö'),
        ),
        migrations.AddField(
            model_name='roianalytics',
            name='tags_assigned',
            field=models.IntegerField(default=0, verbose_name='–¢–µ–≥—ñ–≤ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ'),
        ),
        migrations.AddField(
            model_name='roianalytics',
            name='top_performing_tags',
            field=models.JSONField(default=list, verbose_name='–¢–æ–ø —Ç–µ–≥–∏ –∑–∞ –µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—é'),
        ),
        migrations.AlterField(
            model_name='aiprocessinglog',
            name='log_type',
            field=models.CharField(
                choices=[
                    ('translation', '–ü–µ—Ä–µ–∫–ª–∞–¥'),
                    ('categorization', '–ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü—ñ—è'),
                    ('analysis', '–ê–Ω–∞–ª—ñ–∑'),
                    ('image_generation', '–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∑–æ–±—Ä–∞–∂–µ–Ω—å'),
                    ('cta_generation', '–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è CTA'),
                    ('digest_generation', '–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –¥–∞–π–¥–∂–µ—Å—Ç—É'),
                    ('tag_assignment', '–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ç–µ–≥—ñ–≤')
                ],
                max_length=20,
                verbose_name='–¢–∏–ø –æ–±—Ä–æ–±–∫–∏'
            ),
        ),
        migrations.AlterField(
            model_name='newswidget',
            name='widget_type',
            field=models.CharField(
                choices=[
                    ('latest', '–û—Å—Ç–∞–Ω–Ω—ñ –Ω–æ–≤–∏–Ω–∏'),
                    ('trending', '–ü–æ–ø—É–ª—è—Ä–Ω—ñ –Ω–æ–≤–∏–Ω–∏'),
                    ('category', '–ü–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è—Ö'),
                    ('featured', '–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω—ñ'),
                    ('top_articles', '–¢–æ–ø —Å—Ç–∞—Ç—Ç—ñ')
                ],
                max_length=20,
                verbose_name='–¢–∏–ø –≤—ñ–¥–∂–µ—Ç–∞'
            ),
        ),
        migrations.AlterField(
            model_name='processedarticle',
            name='shares_count',
            field=models.IntegerField(default=0, verbose_name='–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—å'),
        ),
        migrations.AlterField(
            model_name='socialmediapost',
            name='shares_count',
            field=models.IntegerField(default=0, verbose_name='–ü–æ–¥—ñ–ª–∏–ª–∏—Å—å'),
        ),

        # --- –ö–†–û–ö 2: –±–µ–∫—Ñ—ñ–ª slug-—ñ–≤ –¥–ª—è —ñ—Å–Ω—É—é—á–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ ---
        migrations.RunPython(backfill_unique_slugs, migrations.RunPython.noop),

        # --- –ö–†–û–ö 3: –≤–º–∏–∫–∞—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å –¥–ª—è slug ---
        migrations.AlterField(
            model_name='processedarticle',
            name='slug',
            field=models.SlugField(
                verbose_name='Slug',
                help_text='–î–ª—è /news/top/<slug>/',
                max_length=220,
                blank=True,
                null=True,
                unique=True,
            ),
        ),

        # —ñ–Ω–¥–µ–∫—Å–∏ (–ø—ñ—Å–ª—è —Ç–æ–≥–æ, —è–∫ –ø–æ–ª–µ –≤–∂–µ —î —Ç–∞ –∑–∞–ø–æ–≤–Ω–µ–Ω–µ)
        migrations.AddIndex(
            model_name='processedarticle',
            index=models.Index(fields=['slug'], name='news_proces_slug_4806a0_idx'),
        ),
        migrations.AddIndex(
            model_name='processedarticle',
            index=models.Index(fields=['status', 'category'], name='news_proces_status_f5ba22_idx'),
        ),
        migrations.AddIndex(
            model_name='processedarticle',
            index=models.Index(fields=['status', 'published_at'], name='news_proces_status_8870ac_idx'),
        ),
        migrations.AddIndex(
            model_name='processedarticle',
            index=models.Index(fields=['published_at'], name='news_proces_publish_878246_idx'),
        ),
        migrations.AddIndex(
            model_name='processedarticle',
            index=models.Index(fields=['is_top_article', 'article_rank'], name='news_proces_is_top__48c57d_idx'),
        ),
        migrations.AddIndex(
            model_name='processedarticle',
            index=models.Index(fields=['top_selection_date'], name='news_proces_top_sel_cf8ab5_idx'),
        ),

        migrations.AddField(
            model_name='comment',
            name='article',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='comments', to='news.processedarticle'),
        ),
        migrations.AddField(
            model_name='comment',
            name='parent',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='replies', to='news.comment'),
        ),
        migrations.AddField(
            model_name='comment',
            name='user',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL),
        ),
    ]
